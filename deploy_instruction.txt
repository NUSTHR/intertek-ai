适用系统：Ubuntu 22.04 LTS
目标：前后端长期运行，外网可访问

准备内容（先替换）
1) <你的仓库地址> 替换为你的 Git 仓库地址
2) <你的域名或公网IP> 替换为你的域名或服务器公网 IP

一、登录服务器
ssh root@你的服务器公网IP

二、更新系统并安装基础工具
apt update
apt -y upgrade
apt -y install git curl ufw

三、开放端口
ufw allow OpenSSH
ufw allow 80
ufw allow 443
ufw enable

四、安装运行环境
1) 安装 Node.js 22
curl -fsSL https://deb.nodesource.com/setup_22.x | bash -
apt -y install nodejs
node -v
npm -v

2) 安装 Python 与虚拟环境
apt -y install python3 python3-venv python3-pip
python3 -V

3) 安装并启动 Redis
apt -y install redis-server
systemctl enable redis-server
systemctl start redis-server
redis-cli ping

五、拉取项目代码
mkdir -p /srv/ai-questionaire
cd /srv/ai-questionaire
git clone <你的仓库地址> .

六、后端启动为长期服务
python3 -m venv backend/.venv
source backend/.venv/bin/activate
pip install --upgrade pip
pip install -r backend/requirements.txt
deactivate

cat > /etc/systemd/system/aiq-backend.service << EOF
[Unit]
Description=AI Questionnaire Backend
After=network.target redis-server.service

[Service]
Type=simple
User=root
WorkingDirectory=/srv/ai-questionaire
Environment=REDIS_URL=redis://127.0.0.1:6379/0
Environment=ENGINE_CACHE_TTL_SECONDS=30
ExecStart=/srv/ai-questionaire/backend/.venv/bin/python -m uvicorn backend.main:app --host 127.0.0.1 --port 8000 --workers 2
Restart=always
RestartSec=3

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable aiq-backend
systemctl start aiq-backend

七、前端打包
cd /srv/ai-questionaire
npm ci
VITE_API_BASE=/api npm run build

八、配置 Nginx
apt -y install nginx

cat > /etc/nginx/sites-available/ai-questionaire << EOF
server {
    listen 80;
    server_name <你的域名或公网IP>;

    root /srv/ai-questionaire/dist;
    index index.html;

    location /api/ {
        proxy_pass http://127.0.0.1:8000/;
        proxy_http_version 1.1;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
    }

    location /health {
        proxy_pass http://127.0.0.1:8000/health;
    }

    location / {
        try_files \$uri /index.html;
    }
}
EOF

rm -f /etc/nginx/sites-enabled/default
ln -s /etc/nginx/sites-available/ai-questionaire /etc/nginx/sites-enabled/ai-questionaire
nginx -t
systemctl restart nginx

九、HTTPS（有域名才执行）
apt -y install certbot python3-certbot-nginx
certbot --nginx -d <你的域名>

十、验证
curl http://127.0.0.1:8000/health
浏览器访问 http://<你的域名或公网IP>

十一、更新代码
cd /srv/ai-questionaire
git pull
npm ci
VITE_API_BASE=/api npm run build
systemctl restart aiq-backend
systemctl restart nginx
