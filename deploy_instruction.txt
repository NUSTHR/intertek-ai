适用系统：Ubuntu 22.04 LTS
目标：前后端分离部署，前端长期对外提供访问，后端长期运行

一、服务器准备
1. 登录服务器
ssh root@你的服务器公网IP

2. 更新系统
apt update
apt -y upgrade

3. 安装基础工具
apt -y install git curl ufw

4. 开启防火墙
ufw allow OpenSSH
ufw allow 80
ufw allow 443
ufw enable

二、安装运行环境
1. 安装 Node.js 22
curl -fsSL https://deb.nodesource.com/setup_22.x | bash -
apt -y install nodejs
node -v
npm -v

2. 安装 Python 3 与虚拟环境
apt -y install python3 python3-venv python3-pip
python3 -V

3. 安装并启动 Redis
apt -y install redis-server
systemctl enable redis-server
systemctl start redis-server
redis-cli ping

三、获取项目代码
1. 建议使用独立目录
mkdir -p /srv/ai-questionaire
cd /srv/ai-questionaire

2. 拉取代码
git clone <你的仓库地址> .

四、整理前后端目录
1. 创建前端目录
mkdir -p frontend

2. 将前端相关文件移动到 frontend
mv public src index.html package.json package-lock.json vite.config.ts tsconfig.json tsconfig.app.json tsconfig.node.json env.d.ts eslint.config.ts .oxlintrc.json frontend/

3. backend 目录保持不变

五、后端部署（FastAPI + Uvicorn + systemd）
1. 创建 Python 虚拟环境
cd /srv/ai-questionaire
python3 -m venv backend/.venv

2. 安装依赖
source backend/.venv/bin/activate
pip install --upgrade pip
pip install -r backend/requirements.txt
deactivate

3. 创建 systemd 服务
cat > /etc/systemd/system/aiq-backend.service << EOF
[Unit]
Description=AI Questionnaire Backend
After=network.target redis-server.service

[Service]
Type=simple
User=root
WorkingDirectory=/srv/ai-questionaire
Environment=REDIS_URL=redis://127.0.0.1:6379/0
Environment=ENGINE_CACHE_TTL_SECONDS=30
ExecStart=/srv/ai-questionaire/backend/.venv/bin/python -m uvicorn backend.main:app --host 127.0.0.1 --port 8000 --workers 2
Restart=always
RestartSec=3

[Install]
WantedBy=multi-user.target
EOF

4. 启动服务
systemctl daemon-reload
systemctl enable aiq-backend
systemctl start aiq-backend
systemctl status aiq-backend

六、前端构建（Vite）
1. 安装依赖
cd /srv/ai-questionaire/frontend
npm ci

2. 生产构建并指定 API 基路径
VITE_API_BASE=/api npm run build

3. 构建产物在
/srv/ai-questionaire/frontend/dist

七、配置 Nginx 反向代理与静态站点
1. 安装 Nginx
apt -y install nginx

2. 创建站点配置
cat > /etc/nginx/sites-available/ai-questionaire << EOF
server {
    listen 80;
    server_name <你的域名或公网IP>;

    root /srv/ai-questionaire/frontend/dist;
    index index.html;

    location /api/ {
        proxy_pass http://127.0.0.1:8000/;
        proxy_http_version 1.1;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
    }

    location /health {
        proxy_pass http://127.0.0.1:8000/health;
    }

    location / {
        try_files \$uri /index.html;
    }
}
EOF

3. 启用配置并重载
rm -f /etc/nginx/sites-enabled/default
ln -s /etc/nginx/sites-available/ai-questionaire /etc/nginx/sites-enabled/ai-questionaire
nginx -t
systemctl restart nginx

八、配置 HTTPS
1. 安装 certbot
apt -y install certbot python3-certbot-nginx

2. 申请证书
certbot --nginx -d <你的域名>

九、验证部署
1. 检查后端
curl http://127.0.0.1:8000/health

2. 外网访问
浏览器访问 http://<你的域名或公网IP>

十、长期运行与维护
1. 查看后端日志
journalctl -u aiq-backend -f

2. 更新代码流程
cd /srv/ai-questionaire
git pull
cd frontend
npm ci
VITE_API_BASE=/api npm run build
systemctl restart aiq-backend
systemctl restart nginx
